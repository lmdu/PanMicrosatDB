{% extends "psmd/base.html" %}

{% block main %}
<h3 class="mt-5">Comparative analysis <small class="text-muted">select at least two species</small></h3>
<div class="row mt-3">
	<div class="form-group col-md-2">
		<label>Kingdom</label>
		<select name="kingdom" class="form-control" id="kingdom-select">
			<option value="0"></option>
		</select>
	</div>
	<div class="form-group col-md-2">
		<label>Group</label>
		<select name="group" class="form-control" id="group-select">
			<option value="0"></option>
		</select>
	</div>
	<div class="form-group col-md-2">
		<label>Subgroup</label>
		<select name="subgroup" class="form-control" id="subgroup-select">
			<option value="0"></option>
		</select>
	</div>
	<div class="form-group col-md-6">
		<label>Species</label>
		<select name="species" class="form-control form-control-lg" id="species-select">
			<option value="0" selected="selected"></option>
		</select>
	</div>
</div>

<div class="row mt-3">
	<div class="col-10" id="selected-species">
	</div>
	<div class="col-2 text-right">
		<button class="btn btn-sm btn-primary" id="compare-btn">Compare</button>
	</div>
</div>

<div class="row mt-3">
	<div class="col-6 card">
		<div id="ssr-type-bar-chart"></div>
	</div>
</div>

<script type="text/javascript">
var species_list = [];

var colors = ['primary', 'secondary', 'success', 'danger', 'warning', 'info', 'dark'];
$('#species-select').on('change', function(){
	var label = $(this).find('option:selected').text();
	var sid = parseInt($(this).val());

	if(!sid || species_list.includes(sid)){
		return;
	}

	var color = colors[Math.floor(Math.random()*colors.length)];
	var badge_ele = $('<span></span>').addClass('mr-2 badge badge-pill badge-' + color)
		.text(label)
		.data('id', sid);

	var close_ele = $('<span></span>').addClass('ml-2')
		.html('&times;')
		.css('cursor', 'pointer')
		.click(function(){
			$(this).parent().remove();
			var i = $(this).data('id');
			species_list.splice(species_list.indexOf(i), 1);
		})
		.appendTo(badge_ele);

	$('#selected-species').append(badge_ele);
	species_list.push(sid);
});

$('#compare-btn').click(function(){
	//var species = $('#selected-species span').map(function(){
	//	return $(this).data('id');
	//}).get();

	$.post('analysis', {species: species_list}, function(res){		
		Highcharts.chart('ssr-type-bar-chart', {
			chart: {
				type: 'column'
			},
			title: {
				text: 'SSR type distribution'
			},
			xAxis: {
				categories: res.ssr_types
			},
			tooltip: {
				pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>',
				shared: true
			},
			plotOptions: {
				column: {
					stacking: 'percent'
				}
			},
			series: res.ssr_type_dis
		});

	});

});


</script>
{% endblock %}