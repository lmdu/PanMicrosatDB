{% extends "panmicrosatdb/base.html" %}

{% block title %} Browse - PanMicroSatDB {% endblock %}

{% block main %}
{{ csrf_input }}
<div class="row">
	<div class="col-lg-9">
		<div class="pt-5">
			<table id="ssrview" class="table table-striped table-bordered" width="100%">
				<thead>
					<tr>
						<th>ID</th>
						<th>Sequnece Accession</th>
						<th>Sequence Name</th>
						<th>Start</th>
						<th>End</th>
						<th>Motif</th>
						<th>Standard Motif</th>
						<th>Type</th>
						<th>Repeats</th>
						<th>Lenght</th>
					</tr>
				</thead>
				<tbody title="Click to view sequence"></tbody>
			</table>
		</div>
	</div>
	<div class="col-lg-3">
		<div class="pt-5" id="filters">
			<div class="card">
				<h5 class="card-header">Filters</h5>
				<div class="card-body">
					<div class="input-group">
						<div class="input-group-prepend">
							<select class="input-group-text" id="select-seqtype">
								<option value="name">Name</option>
								<option value="accession">Accession</option>
							</select>
						</div>
						<select class="custom-select" name="sequence" id="select-sequence"></select>
					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<label class="input-group-text">Location</label>
						</div>
						<input type="number" id="input-start" name="start" class="form-control">
						<div class="input-group-prepend input-group-append">
							<label class="input-group-text">to</label>
						</div>
						<input type="number" id="input-end" name="end" class="form-control">
					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<label class="input-group-text">Motif =</label>
						</div>
						<input type="text" id="input-motif" name="motif" class="form-control">
					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<label class="input-group-text">Standard Motif =</label>
						</div>
						<input type="text" id="input-smotif" name="smotif" class="form-control">
					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<label class="input-group-text">Type</label>
						</div>
						<select class="custom-select" id="select-ssrtype" name="ssrtype">
							<option value="0">All</option>
							<option value="1">Mono</option>
							<option value="2">Di</option>
							<option value="3">Tri</option>
							<option value="4">Tetra</option>
							<option value="5">Penta</option>
							<option value="6">Hexa</option>
						</select>
					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<label class="input-group-text">Repeats</label>
							<select class="custom-select input-group-text" id="select-repeat-sign" name="repeatsign">
								<option value="gt">></option>
								<option value="gte">>=</option>
								<option value="eq">=</option>
								<option value="lt"><</option>
								<option value="lte"><=</option>
							</select>
						</div>
						<input type="number" id="input-repeats" name="repeats" class="form-control">
					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<label class="input-group-text">Length</label>
							<select class="custom-select input-group-text" id="select-len-sign" name="lensign">
								<option value="gt">></option>
								<option value="gte">>=</option>
								<option value="eq">=</option>
								<option value="lt"><</option>
								<option value="lte"><=</option>
							</select>
						</div>
						<input type="number" id="input-length" name="length" class="form-control">
					</div>
					<div class="mt-3">
						<button type="button" class="btn btn-info" id="apply-filter">Apply filters</button>
						<button type="button" class="btn btn-secondary" id="reset-filter">Reset filters</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- sequence view dialog -->
<div class="modal fade" id="ssr-seq-dialog" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Detailed Sequence</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		        	<span aria-hidden="true">&times;</span>
		        </button>
			</div>
			<div class="modal-body"></div>
		</div>
	</div>
</div>

<script type="text/javascript">
var apply = false;
var table = $('table#ssrview').DataTable({
	processing: true,
	serverSide: true,
	ajax: {
		url: "{{ url('browse') }}",
		type: 'POST',
		data: function(d){
			if(apply){
				d.sequence = $('#select-sequence').val() || '0';
				d.begin = $('#input-start').val() || '0';
				d.end = $('#input-end').val() || '0';
				d.motif = $('#input-motif').val();
				d.smotif = $('#input-smotif').val();
				d.ssrtype = $('#select-ssrtype').val();
				d.repsign = $('#select-repeat-sign').val();
				d.repeats = $('#input-repeats').val() || '0';
				d.lensign = $('#select-len-sign').val();
				d.ssrlen = $('#input-length').val() || '0';
			}
		}
	}
});

$('select#select-sequence').select2({
	placeholder: "Select a sequence by accession",
	width: '100%',
	theme: 'bootstrap4',
	ajax: {
		url: "{{ url('seqid') }}",
		type: 'POST',
		dataType: 'json',
		delay: 250,
		data: function(params){
			return {
				term: params.term,
				page: params.page,
				label: $('select#select-seqtype').val(),
				rows: 10
			};
		},
		processResults: function(data, params){
			params.page = params.page || 1;
			return {
				results: data.results,
				pagination: {
					more: (params.page*params.rows) < data.total
				}
			};
		},
		cache: true,
		minimumInputLength: 1
	},
});


$('#reset-filter').click(function(){
	apply = false;
	$('#filters input').val('');
	$('#filters select').val('').trigger('change');
	$('#select-ssrtype').val('0').trigger('change');
	$('#select-repeat-sign').val('gt').trigger('change');
	$('#select-len-sign').val('gt').trigger('change');
	$('#select-seqtype').val('name').trigger('change');
	table.ajax.reload();
});

$('#apply-filter').click(function(){
	apply = true;
	table.ajax.reload();
});

$('table tbody').on('click', 'tr', function(){
	var row = table.row(this).data();
	$.ajax({
		url: "{{ url('flank') }}",
		method: 'POST',
		data: {ssrid: row[0]},
		dataType: 'json'
	}).done(function(data){
		alert(data.seq);
		$('#ssr-seq-dialog .modal-body').html(data.seq);
		$('#ssr-seq-dialog').modal('show');
	});	
});
</script>
{% endblock %}